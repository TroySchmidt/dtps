/**
 * @file DTPS global search
 * @author jottocraft
 * 
 * @copyright Copyright (c) 2018-2021 jottocraft. All rights reserved.
 * @license GPL-2.0-only
 */
dtps.globalSearch=function(e){var s=e.term,t=e.type,n=e.course;$("#dtpsMainSearchBox").attr("data-search-type",e.type).attr("data-dtps-course",e.course).attr("data-ctx-type",e.ctxType).attr("data-ctx-course",e.ctxCourse),dtps.presentClass("search"),dtps.showClasses(),dtps.selectedContent="stream",$("#dtpsTabBar .btn").removeClass("active"),jQuery(".classContent").html([1,2,3,4].map((()=>'\n            <div class="card assignment graded">\n                <h4>\n                    <span style="width: 450px;" class="shimmer">Assignment Title</span>\n                    <div class="points shimmer">00/00</div>\n                </h4>\n\n                <h5 style="white-space: nowrap; overflow: hidden;">\n                    <div style="width: 200px;" class="infoChip shimmer"></div>\n                    <i class="fluid-icon statusIcon shimmer">more_horiz</i>\n                </h5>\n            </div>\n        ')).join(""));var i=[],a=[],l=[];("all"==n?dtps.classes:[dtps.classes[Number(n)]]).forEach((e=>{"assignments"!=t&&"coursework"!=t&&"everything"!=t||a.push(new Promise(((s,t)=>{if(!e.assignments)return s([]);s(e.assignments.map((s=>({title:s.title,class:e.num,body:$("<div>"+s.body+"</div>").text(),onclick:"dtps.assignment('"+s.id+"', "+s.class+")",locatedIn:s.category?s.category:"Assignment",icon:"assignment",type:"assignment",infoIcons:[s.dueAt?"alarm":null,dtps.user.parent?"person":null].filter((e=>e)),info:[s.dueAt?"Due: "+dtps.formatDate(s.dueAt):null,dtps.user.parent?dtps.user.children.find((s=>s.id==e.userID)).name:null].filter((e=>e)).join("$|$"),icons:[{icon:s.missing?"remove_circle_outline":null,state:"missing"},{icon:s.turnedIn?"assignment_turned_in":null,state:"turnedIn"},{icon:s.locked?"lock_outline":null,state:"locked"},{icon:s.late?"assignment_late":null,state:"late"}].filter((e=>e.icon))}))))}))),"grades"!=t&&"everything"!=t||a.push(new Promise(((s,t)=>{if(!e.assignments)return s([]);var n=[];e.assignments.forEach((s=>{dtpsLMS.useRubricGrades&&s.rubric?s.rubric.forEach((t=>{t.score&&n.push({title:s.title,class:e.num,onclick:"dtps.assignment('"+s.id+"', "+s.class+")",locatedIn:t.title,icon:"assessment",infoIcons:["bar_chart",dtps.user.parent?"person":null].filter((e=>e)),info:["Score: "+t.score+"/"+t.value+(t.scoreName?" "+t.scoreName:""),dtps.user.parent?dtps.user.children.find((s=>s.id==e.userID)).name:null].filter((e=>e)).join("$|$"),icons:[]})})):s.grade&&n.push({title:s.title,class:e.num,onclick:"dtps.assignment('"+s.id+"', "+s.class+")",locatedIn:"Grade",icon:"assessment",infoIcons:["bar_chart",dtps.user.parent?"person":null].filter((e=>e)),info:["Score: "+s.grade+"/"+s.value+" ("+Math.round(s.grade/s.value*100)+"%"+(s.letter?", "+s.letter:"")+")",dtps.user.parent?dtps.user.children.find((s=>s.id==e.userID)).name:null].filter((e=>e)).join("$|$"),icons:[]})})),s(n)}))),l.includes(e.lmsID)||(l.push(e.lmsID),"modules"!=t&&"coursework"!=t&&"everything"!=t||a.push(new Promise(((s,n)=>{if(!e.modules)return s([]);new Promise((s=>{e.modules&&!0!==e.modules?s(e.modules):dtpsLMS.fetchModules(dtps.user.id,e.lmsID).then((e=>s(e)))})).then((n=>{var i=[];n.forEach((e=>{e.items.forEach((s=>{"assignment"==s.type&&"coursework"==t||(s.locatedIn=e.title,i.push(s))}))})),s(i.map((s=>({title:s.title,class:e.num,url:s.url,locatedIn:s.locatedIn,icon:"view_module",infoIcons:["category"].filter((e=>e)),info:["Type: "+s.type].filter((e=>e)).join("$|$"),icons:[{icon:s.completed?"check":null,keywords:"completed done submitted"}].filter((e=>e.icon))}))))})).catch((()=>s([])))}))),"homepages"!=t&&"everything"!=t||a.push(new Promise(((s,t)=>{if(!e.homepage)return s([]);dtpsLMS.fetchHomepage(e.lmsID).then((t=>{s([{title:e.subject+" Homepage",class:e.num,onclick:"dtps.classHome("+e.num+");",locatedIn:e.subject,icon:"home",body:$("<div>"+t+"</div>").text(),icons:[]}])})).catch((()=>s([])))}))),"pages"!=t&&"everything"!=t||a.push(new Promise(((s,t)=>{if(!e.pages)return s([]);dtpsLMS.fetchPages(e.lmsID).then((t=>{Promise.all(t.map((s=>dtpsLMS.fetchPageContent(e.lmsID,s.id)))).then((t=>{s(t.map((s=>({title:s.title,class:e.num,onclick:"fluid.screen('pages', '"+e.id+"|"+s.id+"');",body:$("<div>"+s.content+"</div>").text(),locatedIn:"Page",icon:"insert_drive_file",infoIcons:[s.author&&s.author.name?"person":null].filter((e=>e)),info:[s.author&&s.author.name?"Author: "+s.author&&s.author.name:null].filter((e=>e)).join("$|$"),icons:[]}))))}))})).catch((()=>s([])))}))),"discussions"!=t&&"everything"!=t||a.push(new Promise(((s,t)=>{if(!e.discussions)return s([]);dtpsLMS.fetchDiscussionThreads(e.lmsID).then((t=>{Promise.all(t.map((s=>dtpsLMS.fetchDiscussionPosts(e.lmsID,s.id)))).then((t=>{var n=[];t.forEach((e=>{e.posts.forEach((s=>{s.locatedIn=e.title,s.threadID=e.id,n.push(s),s.replies&&s.replies.forEach((s=>{s.locatedIn=e.title,s.threadID=e.id,n.push(s)}))}))})),s(n.map((s=>({body:$("<div>"+s.body+"</div>").text(),class:e.num,onclick:"fluid.screen('discussions', '"+e.id+"|"+s.threadID+"|false|"+s.id+"');",locatedIn:s.locatedIn,icon:"forum",infoIcons:[s.author&&s.author.name?"person":null,s.postedAt?"calendar_today":null].filter((e=>e)),info:[s.author&&s.author.name?"Author: "+s.author&&s.author.name:null,s.postedAt?"Posted At: "+dtps.formatDate(s.postedAt):null].filter((e=>e)).join("$|$"),icons:[]}))))}))})).catch((()=>s([])))}))),"people"!=t&&"everything"!=t||a.push(new Promise(((s,t)=>{if(!e.people)return s([]);new Promise((s=>{e.people&&!0!==e.people?s(e.people):dtpsLMS.fetchUsers(e.lmsID).then((e=>s(e)))})).then((t=>{var n=[];t.forEach((e=>{e.users.forEach((s=>{s.locatedIn=e.title,n.push(s)}))})),s(n.map((s=>({title:s.name,class:e.num,url:s.url,locatedIn:s.locatedIn,icon:"people",icons:[]}))))})).catch((()=>s([])))}))),"announcements"!=t&&"everything"!=t||a.push(new Promise(((s,t)=>{dtpsLMS.fetchAnnouncements(e.lmsID).then((t=>{s(t.map((s=>({title:s.title,url:s.url,class:e.num,locatedIn:e.subject,icon:"announcement",body:$("<div>"+s.body+"</div>").text(),infoIcons:["calendar_today"].filter((e=>e)),info:["Posted at: "+dtps.formatDate(s.postedAt)].filter((e=>e)).join("$|$"),icons:[]}))))})).catch((()=>s([])))}))))})),Promise.all(a).then((e=>{e.forEach((e=>{i=i.concat(e)}));var a=lunr((function(){this.ref("id"),this.field("title"),this.field("body"),this.field("locatedIn"),this.field("info"),this.metadataWhitelist=["position"],i.forEach((function(e,s){this.add({id:s,...e})}),this)})).search(s),l=a.map((e=>dtps.renderSearchResult(i[Number(e.ref)],e.matchData.metadata,"all"==n))).join("");if("search"==dtps.selectedClass&&($(".headerArea .contentLabel i").text("find_in_page"),$(".headerArea .contentLabel span").text(a.length+" results"),$(".headerArea .contentLabel").show(),$(".classContent").html(`\n                <div ${["assignments","coursework"].includes(t)?"":'style="display: none;"'} id="searchFilterContainer">\n                    <div id="searchFilterCard" class="card">\n                        <h5><i class="fluid-icon">filter_alt</i><span>Filters</span></h5>\n                        <div class="checkContainer">\n                            <div id="missingSearchFilter" init="true" onclick="dtps.filterSearch(this)" class="checkbox"><i class="fluid-icon">check</i></div> \n                            <div class="label"><i class="fluid-icon">remove_circle_outline</i> Missing</div> \n                        </div>\n                        <div class="checkContainer">\n                            <div id="turnedInSearchFilter" init="true" onclick="dtps.filterSearch(this)" class="checkbox"><i class="fluid-icon">check</i></div> \n                            <div class="label"><i class="fluid-icon">assignment_turned_in</i> Turned in</div> \n                        </div>\n                        <div class="checkContainer">\n                            <div id="lateSearchFilter" init="true" onclick="dtps.filterSearch(this)" class="checkbox"><i class="fluid-icon">check</i></div> \n                            <div class="label"><i class="fluid-icon">assignment_late</i> Late</div> \n                        </div>\n                        <div class="checkContainer">\n                            <div id="lockedSearchFilter" init="true" onclick="dtps.filterSearch(this)" class="checkbox"><i class="fluid-icon">check</i></div> \n                            <div class="label"><i class="fluid-icon">lock_outline</i> Locked</div> \n                        </div>\n                    </div>\n                </div>\n                <div ${["assignments","coursework"].includes(t)?'class="withFilters"':""} id="searchResultsContainer">\n                    ${l}\n                </div>\n            `),!dtps.searchScrollListener)){dtps.searchScrollListener=!0;var o=document.getElementById("searchFilterCard").offsetTop-parseFloat($("body").css("padding-top"));window.onscroll=function(){window.pageYOffset>=o&&"search"==dtps.selectedClass?$(".classContent").addClass("fixedSearchFilters"):$(".classContent").removeClass("fixedSearchFilters")}}dtps.filterSearch=function(e){e&&$(e).toggleClass("active");var s=$("#missingSearchFilter").hasClass("active"),t=$("#turnedInSearchFilter").hasClass("active"),l=$("#lateSearchFilter").hasClass("active"),o=$("#lockedSearchFilter").hasClass("active"),c=s||t||l||o,r=a.filter((function(e){var n=i[Number(e.ref)];if(!c)return!0;if("assignment"==n.type){if(s&&n.icons.map((e=>e.state)).includes("missing"))return!0;if(t&&n.icons.map((e=>e.state)).includes("turnedIn"))return!0;if(l&&n.icons.map((e=>e.state)).includes("late"))return!0;if(o&&n.icons.map((e=>e.state)).includes("locked"))return!0}return!1})),d=r.map((e=>dtps.renderSearchResult(i[Number(e.ref)],e.matchData.metadata,"all"==n))).join("");"search"==dtps.selectedClass&&($(".headerArea .contentLabel i").text(c?"filter_alt":"find_in_page"),$(".headerArea .contentLabel span").text(r.length+" results"),$(".headerArea .contentLabel").show(),$("#searchResultsContainer").html(d))}}))},dtps.renderSearchResult=function(e,s,t){if(!e.processed){var n={};function i(e,s){var t=e.split("");return s.forEach((e=>{t.forEach(((s,n)=>{n==e[0]&&(t[n]='<span class="highlight">'+t[n]),n==e[0]+e[1]-1&&(t[n]=t[n]+"</span>")}))})),t.join("")}Object.values(s).forEach((e=>{Object.keys(e).forEach((s=>{n[s]?n[s]=n[s].concat(e[s].position):n[s]=e[s].position}))})),n=Object.keys(n).map((e=>({key:e,position:n[e]}))),e.bodyParts=[],e.bodyOverflow=0,n.forEach((s=>{if("title"==s.key)e.title=i(e.title,s.position);else if("locatedIn"==s.key)e.locatedIn=i(e.locatedIn,s.position);else if("body"==s.key){var t=s.position.sort(((e,s)=>s[1]-e[1])),n=2;t.length<n&&(n=t.length),e.bodyOverflow=t.length-n;for(var a=0;a<n;a++){var l=t[a][0],o=t[a][0]+t[a][1]-1,c=l-10,r=o+10;c<0&&(c=0),r>e.body.length-1&&(r=e.body.length-1);var d=e.body.slice(c,l)+'<span class="highlight">'+e.body.slice(l,o+1)+"</span>"+e.body.slice(o+1,r+1);e.bodyParts.push(d)}}else"info"==s.key&&(e.info=i(e.info,s.position))})),e.info&&(e.info=e.info.split("$|$").map(((s,t)=>({icon:e.infoIcons[t],info:s})))),e.processed=!0}return`\n        <div \n            class="card searchResult ${t?"mixedClasses":""}"\n            style="${"--classColor: "+dtps.classes[e.class].color}"\n            onclick="${e.onclick||e.url&&"window.open('"+e.url+"')"}"\n        >\n\n            \x3c!-- Color bar for the dashboard --\x3e\n            <div class="colorBar"></div>\n\n            \x3c!-- Assignment title and points --\x3e\n            ${e.title?`<h4>${e.title}</h4>`:""}\n\n            <h5>\n                <div class="infoChip"><i style="margin-top: -2px;" class="fluid-icon">${e.icon}</i> ${e.locatedIn}</div>\n                ${e.info?e.info.map((e=>`<div class="infoChip"><i style="margin-top: -2px;" class="fluid-icon">${e.icon}</i> ${e.info}</div>`)).join(""):""}\n            </h5>\n\n            ${e.bodyParts.map((e=>`<p><span style="color: var(--secText);">...</span>${e}<span style="color: var(--secText);">...</span></p>`)).join("")}\n            ${e.bodyOverflow?`<p style="color: var(--secText);">+${e.bodyOverflow} more matches</p>`:""}\n\n            <h5>\n                ${e.icons.map(((e,s)=>`<i class="fluid-icon statusIcon">${e.icon}</i>`)).join("")}\n            </h5>\n        </div>\n    `},fluid.externalScreens.search=e=>{dtps.globalSearch(e)};
//# sourceMappingURL=/scripts/search.js.map