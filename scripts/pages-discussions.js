/**
 * @file DTPS pages & discussion functions
 * @author jottocraft
 * 
 * @copyright Copyright (c) 2018-2020 jottocraft. All rights reserved.
 * @license GPL-2.0-only
 */
dtps.loadThreadsList=function(s,e){var t=dtps.classes.map(s=>s.id).indexOf(s);dtps.selectedClass=t,dtps.selectedContent="discuss",$("#dtpsTabBar .btn").removeClass("active"),$("#dtpsTabBar .btn.discuss").addClass("active"),-1==t&&dtps.error("The selected class doesn't exist","classNum check failed @ dtps.loadThreadsList"),dtps.presentClass(t),jQuery("body").removeClass("collapsedSidebar"),dtps.selectedClass==t&&"discuss"==dtps.selectedContent&&(jQuery(".sidebar").html('\n            <div class="bigLogo" style="text-align: center; margin: 10px 0 20px; height: 38px;">\n                <i style="font-size: 28px; margin-right: 7px; vertical-align: middle;" class="material-icons">forum</i>\n                <h4 style="color: var(--text); display: inline-block; font-size: 28px; vertical-align: middle; margin: 0px;">Discussions</h4>\n            </div>\n                        \n            <div class="items">\n                <div class="spinner"></div>\n            </div>\n        '),jQuery(".classContent").html("")),dtpsLMS.fetchDiscussionThreads(dtps.classes[t].id).then((function(s){if(dtps.classes[t].discussions=s,0==dtps.classes[t].discussions.length)jQuery(".sidebar .items").html(`\n                <div onclick="fluid.screen('stream', '${dtps.classes[t].id}');" class="class item main back">\n                    <span class="label">Classes</span>\n                    <div class="icon">\n                        <i class="material-icons">keyboard_arrow_left</i>\n                    </div>\n                </div>\n\n                <p style="text-align: center; font-weight: bold; margin-top: 60px;">No discussions found</p>\n                <p style="text-align: center; font-size: 14px;">This class doesn't have any discussions</p>\n            `);else{var n=dtps.classes[t].discussions.map(s=>`\n                    <div data-threadID="${s.id}" class="item">\n                        <span class="label">${s.title}</span>\n                        <div class="icon">\n                            <i style="font-family: 'Material Icons Extended';" class="material-icons">${s.locked?"lock_outline":"chat_bubble_outline"}</i>\n                        </div>\n                    </div>\n                `).join("");dtps.selectedClass==t&&"discuss"==dtps.selectedContent&&(jQuery(".sidebar .items").html(`\n                    <div onclick="fluid.screen('stream', '${dtps.classes[t].id}');" class="class item main back">\n                        <span class="label">Classes</span>\n                        <div class="icon">\n                            <i class="material-icons">keyboard_arrow_left</i>\n                        </div>\n                    </div>\n\n                    ${dtps.classes[t].newDiscussionThreadURL?`\n                            <div onclick="window.open('${dtps.classes[t].newDiscussionThreadURL}')" class="class item back">\n                                <span class="label">New discussion</span>\n                                <div class="icon">\n                                    <i class="material-icons">add</i>\n                                </div>\n                            </div>\n                        `:""}\n\n                    <div class="divider"></div>\n\n                    ${n}\n                `),e&&dtps.loadThreadPosts(t,e),$(".sidebar .item:not(.back)").click((function(s){$(this).siblings().removeClass("active"),$(this).addClass("active");var e=$(this).attr("data-threadID");dtps.loadThreadPosts(t,e)})))}})).catch((function(s){dtps.error("Couldn't fetch discussion threads","Caught promise rejection @ dtps.loadThreadsList",s)}))},dtps.loadThreadPosts=function(s,e){dtps.selectedClass==s&&"discuss"==dtps.selectedContent&&jQuery(".classContent").html('<div class="spinner"></div>');var t=null;if(dtps.classes[s].discussions.forEach(s=>{s.id==e&&(t=s)}),!t)throw dtps.error("Thread does not exist","thread is null @ dtps.loadThreadPosts"),null;dtpsLMS.fetchDiscussionPosts(dtps.classes[s].id,e).then((function(e){t.posts=e;var n=[];t.posts.forEach((s,e)=>{var a=getComputedStyle($(".card.details")[0]).getPropertyValue("--cards"),i=getComputedStyle($(".card.details")[0]).getPropertyValue("--text"),l=new Blob([`\n                    <base target="_blank" /> \n                    <link type="text/css" rel="stylesheet" href="https://cdn.jottocraft.com/CanvasCSS.css" media="screen,projection"/>\n                    <style>body {background-color: ${a}; color: ${i};</style>\n                    ${s.body}\n                `],{type:"text/html"}),d=(window.URL.createObjectURL(l),[]);s.replies&&(d.push("<br />"),s.replies.forEach(e=>{d.push(`\n                        <div style="margin-left: ${50*(e.depth||0)}px;" class="discussionReply">\n                            <div class="discussionHeader">\n                                ${s.author?`\n                                    <img src="${e.author.photoURL}" />\n                                    <h5>${e.author.name}</h5>\n                                `:""}\n                                \n                                <span style="cursor: pointer;" onclick="window.open('${e.replyURL}')">\n                                    <i class="material-icons">reply</i>\n                                    <span>Reply</span>\n                                </span>\n                            </div>\n\n                            ${e.body}\n                        </div>\n                    `)}),d.push("<br />")),n.push(`\n                    <div class="card" style="margin-top: 20px;${0==e?"margin-bottom: 75px;":"padding: 20px 30px;"}">\n                        \x3c!-- Thread title (Initial post) --\x3e\n                        ${0==e?`\n                            <h4 style="font-weight: bold">${t.title}</h4>\n                        `:""}\n\n                        \x3c!-- Author header --\x3e\n                        <div ${0==e?'style="margin-bottom: 32px;"':""} class="discussionHeader">\n                            ${s.author?`\n                                <img src="${s.author.photoURL}" />\n                                <h5>${s.author.name}</h5>\n                            `:""}\n\n                            <i class="material-icons">calendar_today</i>\n                            <span>${dtps.formatDate(s.postedAt)}</span>\n\n                            \x3c!-- Thread info (initial post) --\x3e\n                            ${0==e?`\n                                ${t.locked?'<i class="material-icons">lock</i>':""}\n                                ${t.requireInitialPost?'\n                                    <i class="material-icons">visibility</i>\n                                    <span>You must post before you can see other replies</span>\n                                ':""}\n                            `:""}\n                        </div>\n         \n                        ${s.body}\n\n                        ${d.join("")}\n\n                        \x3c!-- Reply / Add post footer --\x3e\n                        ${s.replyURL?`\n                            <div ${0==e?'style="margin-top: 32px;"':""} class="discussionFooter">\n                                ${0==e?`\n                                    <button onclick="window.open('${s.replyURL}')" class="btn small"><i class="material-icons">post_add</i> Add Post</button>\n                                `:`\n                                    <button onclick="window.open('${s.replyURL}')" class="btn small"><i class="material-icons">reply</i> Reply</button>\n                                `}\n                            </div> \n                        `:""}\n                    </div>\n                `)}),dtps.selectedClass==s&&"discuss"==dtps.selectedContent&&jQuery(".classContent").html(n.join(""))})).catch((function(s){dtps.error("Could not fetch discussion posts","Caught promise rejection @ dtps.loadThreadPosts",s)}))},dtps.loadPagesList=function(s,e){var t=dtps.classes.map(s=>s.id).indexOf(s);dtps.selectedClass=t,dtps.selectedContent="pages",$("#dtpsTabBar .btn").removeClass("active"),$("#dtpsTabBar .btn.pages").addClass("active"),-1==t&&dtps.error("The selected class doesn't exist","classNum check failed @ dtps.loadPagesList"),dtps.presentClass(t),jQuery("body").removeClass("collapsedSidebar"),dtps.selectedClass==t&&"pages"==dtps.selectedContent&&(jQuery(".sidebar").html('\n            <div class="bigLogo" style="text-align: center; margin: 10px 0 20px; height: 38px;">\n                <i style="font-size: 28px; margin-right: 7px; vertical-align: middle;" class="material-icons">insert_drive_file</i>\n                <h4 style="color: var(--text); display: inline-block; font-size: 28px; vertical-align: middle; margin: 0px;">Pages</h4>\n            </div>\n                        \n            <div class="items">\n                <div class="spinner"></div>\n            </div>\n        '),jQuery(".classContent").html("")),dtpsLMS.fetchPages(dtps.classes[t].id).then((function(s){if(dtps.classes[t].pages=s,0==s.length)jQuery(".sidebar .items").html(`\n                <div onclick="fluid.screen('stream', '${dtps.classes[t].id}');" class="class item main back">\n                    <span class="label">Classes</span>\n                    <div class="icon">\n                        <i class="material-icons">keyboard_arrow_left</i>\n                    </div>\n                </div>\n\n                <p style="text-align: center; font-weight: bold; margin-top: 60px;">No pages found</p>\n                <p style="text-align: center; font-size: 14px;">This class doesn't have any pages</p>\n            `);else{var n=dtps.classes[t].pages.map(s=>`\n                    <div data-pageID="${s.id}" class="item ${e&&s.id==e?"active":""}">\n                        <span class="label">${s.title}</span>\n                        <div class="icon">\n                            <i class="material-icons">insert_drive_file</i>\n                        </div>\n                    </div>\n                `).join("");dtps.selectedClass==t&&"pages"==dtps.selectedContent&&jQuery(".sidebar .items").html(`\n                    <div onclick="fluid.screen('stream', '${dtps.classes[t].id}');" class="class item main back">\n                        <span class="label">Classes</span>\n                        <div class="icon">\n                            <i class="material-icons">keyboard_arrow_left</i>\n                        </div>\n                    </div>\n\n                    <div class="divider"></div>\n\n                    ${n}\n                `),e&&dtps.loadPage(t,e),$(".sidebar .item:not(.back)").click((function(s){$(this).siblings().removeClass("active"),$(this).addClass("active");var e=$(this).attr("data-pageID");dtps.loadPage(t,e)}))}})).catch(s=>{dtps.error("Couldn't fetch pages","Caught promise rejection @ dtps.loadPagesList",s)})},dtps.loadPage=function(s,e){dtps.selectedClass==s&&"pages"==dtps.selectedContent&&jQuery(".classContent").html('<div class="spinner"></div>');var t=null;if(dtps.classes[s].pages.forEach(s=>{s.id==e&&(t=s)}),!t)throw dtps.error("Page does not exist","page is null @ dtps.loadPage"),null;dtpsLMS.fetchPageContent(dtps.classes[s].id,t.id).then((function(e){if(t.content=e,dtps.selectedClass==s&&"pages"==dtps.selectedContent){var n=getComputedStyle($(".card.details")[0]).getPropertyValue("--cards"),a=getComputedStyle($(".card.details")[0]).getPropertyValue("--text"),i=new Blob([`\n                <base target="_blank" /> \n                <link type="text/css" rel="stylesheet" href="https://cdn.jottocraft.com/CanvasCSS.css" media="screen,projection"/>\n                <style>body {background-color: ${n}; color: ${a};</style>\n                ${t.content}\n            `],{type:"text/html"}),l=window.URL.createObjectURL(i);jQuery(".classContent").html(`\n                <div class="card">\n                    \x3c!-- Page title --\x3e\n                    <h4 style="font-weight: bold;">${t.title}</h4>\n\n                    \x3c!-- Page header --\x3e\n                    <div style="margin-bottom: 32px;" class="discussionHeader">\n                        ${t.author?`\n                            <img src="${t.author.photoURL}" />\n                            <h5>${t.author.name}</h5>\n                        `:""}\n\n                        <i class="material-icons">calendar_today</i>\n                        <span>${"Last Updated "+dtps.formatDate(t.updatedAt)}</span>\n                    </div>\n\n                    \x3c!-- Page content --\x3e\n                    <br />\n                    <iframe id="classPageIframe" onload="dtps.iframeLoad('classPageIframe')" style="margin: 10px 0px; width: 100%; border: none; outline: none;" src="${l}" />\n                </div>\n            `)}})).catch(s=>{dtps.error("Couldn't load page","Caught promise rejection @ dtps.loadPage",s)})},fluid.externalScreens.discussions=s=>{var e=s.split("|")[0],t=s.split("|")[1];dtps.loadThreadsList(e,t)},fluid.externalScreens.pages=s=>{var e=s.split("|")[0],t=s.split("|")[1];dtps.loadPagesList(e,t)};
//# sourceMappingURL=/scripts/pages-discussions.js.map