/**
 * @file DTPS pages & discussion functions
 * @author jottocraft
 * 
 * @copyright Copyright (c) 2018-2021 jottocraft. All rights reserved.
 * @license GPL-2.0-only
 */
dtps.loadThreadsList=function(s,e,n,t){var a=dtps.classes.map((s=>s.id)).indexOf(s);dtps.selectedClass=a,n||(dtps.selectedContent="discuss",$("#dtpsTabBar .btn").removeClass("active"),$("#dtpsTabBar .btn.discuss").addClass("active"),jQuery("body").removeClass("collapsedSidebar")),-1==a&&dtps.error("The selected class doesn't exist","classNum check failed @ dtps.loadThreadsList"),dtps.presentClass(a),n?dtps.loadThreadPosts(a,e,n,t):(dtps.selectedClass==a&&"discuss"==dtps.selectedContent&&(jQuery(".sidebar").html(`\n            <div class="title">\n                <i style="font-size: 28px; margin-right: 7px; vertical-align: middle;" class="fluid-icon">forum</i>\n               <h4>Discussions</h4>\n             </div>\n                        \n            <div class="items">\n                <div onclick="fluid.screen('stream', '${dtps.classes[a].id}');" class="item main back">\n                    <i class="fluid-icon">keyboard_arrow_left</i> <span class="label">Classes</span>\n                </div>\n\n                <div class="divider"></div>\n\n                <div class="item shimmerParent">\n                    <i class="fluid-icon">star</i>\n                    <span class="label">Discussion thread Title</span>\n                </div>\n                <div class="item shimmerParent">\n                    <i class="fluid-icon">star</i>\n                    <span class="label">Discussion thread Title</span>\n                </div>\n                <div class="item shimmerParent">\n                    <i class="fluid-icon">star</i>\n                    <span class="label">Discussion thread Title</span>\n                </div>\n            </div>\n        `),jQuery(".classContent").html("")),dtpsLMS.fetchDiscussionThreads(dtps.classes[a].lmsID).then((function(s){if(dtps.classes[a].discussions=s,0==dtps.classes[a].discussions.length)jQuery(".sidebar .items").html(`\n                <div onclick="fluid.screen('stream', '${dtps.classes[a].id}');" class="item main back">\n                    <i class="fluid-icon">keyboard_arrow_left</i> <span class="label">Classes</span>\n                </div>\n\n                <p style="text-align: center; font-weight: bold; margin-top: 60px; margin-bottom: 10px;">No discussions found</p>\n                <p style="text-align: center; font-size: 14px; margin: 0px;">This class doesn't have any discussions</p>\n            `);else{var i=dtps.classes[a].discussions.map((s=>`\n                    <div data-threadID="${s.id}" class="item">\n                        <i class="fluid-icon">${s.locked?"lock_outline":"chat_bubble_outline"}</i>\n                        <span class="label">${s.title}</span>\n                    </div>\n                `)).join("");dtps.selectedClass==a&&"discuss"==dtps.selectedContent&&(jQuery(".sidebar .items").html(`\n                <div onclick="fluid.screen('stream', '${dtps.classes[a].id}');" class="item main back">\n                    <i class="fluid-icon">keyboard_arrow_left</i> <span class="label">Classes</span>\n                </div>\n\n                    ${dtps.classes[a].newDiscussionThreadURL?`\n                            <div onclick="window.open('${dtps.classes[a].newDiscussionThreadURL}')" class="item back">\n                                <i class="fluid-icon">add</i>\n                                <span class="label">New discussion</span>\n                            </div>\n                        `:""}\n\n                    <div class="divider"></div>\n\n                    ${i}\n                `),e&&dtps.loadThreadPosts(a,e,n,t),$(".sidebar .item:not(.back)").click((function(s){$(this).siblings().removeClass("active"),$(this).addClass("active");var e=$(this).attr("data-threadID");dtps.loadThreadPosts(a,e)})))}})).catch((function(s){dtps.error("Couldn't fetch discussion threads","Caught promise rejection @ dtps.loadThreadsList",s)})))},dtps.loadThreadPosts=function(s,e,n,t){dtps.selectedClass!=s||"discuss"!=dtps.selectedContent&&!n||jQuery(".classContent").html('\n            <div class="card" style="margin-top: 20px;margin-bottom: 75px;">\n                <h4><span class="shimmer">[SHIMMER] Thread Title</span></h4>\n\n                <div style="margin-bottom: 32px;" class="discussionHeader">\n                    <h5 ><span class="shimmer">Discussion author name</span></h5>\n\n                    <i class="fluid-icon shimmer">calendar_today</i>\n                    <span class="shimmer">Discussion date</span>\n                </div>\n\n                <div class="shimmer" style="margin: 10px 0px; width: 100%; height: 400px; border: none; outline: none;"></div>\n\n                <div style="margin-top: 32px;" class="discussionFooter">\n                    <button class="btn small shimmer"><i class="fluid-icon">post_add</i> Add Post</button>\n                </div> \n            </div>\n        '),dtpsLMS.fetchDiscussionPosts(dtps.classes[s].lmsID,e).then((function(e){var a=[];e.posts.forEach(((s,n)=>{var t=getComputedStyle($(".card.details")[0]).getPropertyValue("--cards"),i=getComputedStyle($(".card.details")[0]).getPropertyValue("--text"),l=new Blob([`\n                    <base target="_blank" /> \n                    <link type="text/css" rel="stylesheet" href="https://cdn.jottocraft.com/CanvasCSS.css" media="screen,projection"/>\n                    <style>body {background-color: ${t}; color: ${i};</style>\n                    ${s.body}\n                `],{type:"text/html"}),d=window.URL.createObjectURL(l),c=[];s.replies&&(c.push("<br />"),s.replies.forEach((e=>{c.push(`\n                        <div data-post-id="${e.id}" style="margin-left: ${50*(e.depth||0)}px;" class="discussionReply">\n                            <div class="discussionHeader">\n                                ${s.author?`\n                                    <img src="${e.author.photoURL}" />\n                                    <h5>${e.author.name}</h5>\n                                `:""}\n                                \n                                <span style="cursor: pointer;" onclick="window.open('${e.replyURL}')">\n                                    <i class="fluid-icon">reply</i>\n                                    <span>Reply</span>\n                                </span>\n                            </div>\n\n                            ${e.body}\n                        </div>\n                    `)})),c.push("<br />")),a.push(`\n                    <div class="card" data-post-id="${s.id}" style="margin-top: 20px;${0==n?"margin-bottom: 75px;":"padding: 20px 30px;"}">\n                        \x3c!-- Thread title (Initial post) --\x3e\n                        ${0==n?`\n                            <h4 style="font-weight: bold">${e.title}</h4>\n                        `:""}\n\n                        \x3c!-- Author header --\x3e\n                        <div ${0==n?'style="margin-bottom: 32px;"':""} class="discussionHeader">\n                            ${s.author?`\n                                <img src="${s.author.photoURL}" />\n                                <h5>${s.author.name}</h5>\n                            `:""}\n\n                            <i class="fluid-icon">calendar_today</i>\n                            <span>${dtps.formatDate(s.postedAt)}</span>\n\n                            \x3c!-- Thread info (initial post) --\x3e\n                            ${0==n?`\n                                ${e.locked?'<i class="fluid-icon">lock</i>':""}\n                                ${e.requireInitialPost?'\n                                    <i class="fluid-icon">visibility</i>\n                                    <span>You must post before you can see other replies</span>\n                                ':""}\n                            `:""}\n                        </div>\n         \n                        ${0==n?`\n                            <iframe id="classThreadIframe" onload="dtps.iframeLoad('classThreadIframe')" style="margin: 10px 0px; width: 100%; border: none; outline: none;" src="${d}" />\n                        `:s.body}\n\n                        ${c.join("")}\n\n                        \x3c!-- Reply / Add post footer --\x3e\n                        ${s.replyURL?`\n                            <div ${0==n?'style="margin-top: 32px;"':""} class="discussionFooter">\n                                ${0==n?`\n                                    <button onclick="window.open('${s.replyURL}')" class="btn small"><i class="fluid-icon">post_add</i> Add Post</button>\n                                `:`\n                                    <button onclick="window.open('${s.replyURL}')" class="btn small"><i class="fluid-icon">reply</i> Reply</button>\n                                `}\n                            </div> \n                        `:""}\n                    </div>\n                `)})),dtps.selectedClass!=s||"discuss"!=dtps.selectedContent&&!n||(jQuery(".classContent").html((n?`\n                <button style="margin: 10px 0px 0px 20px;" class="btn" onclick="fluid.screen('moduleStream', '${dtps.classes[s].id}')">\n                    <i class="fluid-icon">keyboard_arrow_left</i> Back\n                </button>\n            `:"")+a.join("")),t&&$("[data-post-id="+t+"]").get(0).scrollIntoView())})).catch((function(s){dtps.error("Could not fetch discussion posts","Caught promise rejection @ dtps.loadThreadPosts",s)}))},dtps.loadPagesList=function(s,e,n){var t=dtps.classes.map((s=>s.id)).indexOf(s);dtps.selectedClass=t,n||(dtps.selectedContent="pages",$("#dtpsTabBar .btn").removeClass("active"),$("#dtpsTabBar .btn.pages").addClass("active"),jQuery("body").removeClass("collapsedSidebar")),-1==t&&dtps.error("The selected class doesn't exist","classNum check failed @ dtps.loadPagesList"),dtps.presentClass(t),n?dtps.loadPage(t,e,n):(dtps.selectedClass==t&&"pages"==dtps.selectedContent&&(jQuery(".sidebar").html(`\n            <div class="title">\n                <i style="font-size: 28px; margin-right: 7px; vertical-align: middle;" class="fluid-icon">insert_drive_file</i>\n                <h4>Pages</h4>\n             </div>\n\n             <div class="items">\n                <div onclick="fluid.screen('stream', '${dtps.classes[t].id}');" class="item main back">\n                    <i class="fluid-icon">keyboard_arrow_left</i> <span class="label">Classes</span>\n                </div>\n\n                <div class="divider"></div>\n\n                <div class="item shimmerParent">\n                    <i class="fluid-icon">star</i>\n                    <span class="label">Class page title</span>\n                </div>\n                <div class="item shimmerParent">\n                    <i class="fluid-icon">star</i>\n                    <span class="label">Class page title</span>\n                </div>\n                <div class="item shimmerParent">\n                    <i class="fluid-icon">star</i>\n                    <span class="label">Class page title</span>\n                </div>\n            </div>\n        `),jQuery(".classContent").html("")),dtpsLMS.fetchPages(dtps.classes[t].lmsID).then((function(s){if(dtps.classes[t].pages=s,0==s.length)jQuery(".sidebar .items").html(`\n                <div onclick="fluid.screen('stream', '${dtps.classes[t].id}');" class="item main back">\n                    <i class="fluid-icon">keyboard_arrow_left</i>\n                    <span class="label">Classes</span>\n                </div>\n\n                <p style="text-align: center; font-weight: bold; margin-top: 60px; margin-bottom: 10px;">No pages found</p>\n                <p style="text-align: center; font-size: 14px; margin: 0px;">This class doesn't have any pages</p>\n            `);else{var n=dtps.classes[t].pages.map((s=>`\n                    <div data-pageID="${s.id}" class="item ${e&&s.id==e?"active":""}">\n                        <i class="fluid-icon">insert_drive_file</i>    \n                        <span class="label">${s.title}</span>\n                    </div>\n                `)).join("");dtps.selectedClass==t&&"pages"==dtps.selectedContent&&jQuery(".sidebar .items").html(`\n                    <div onclick="fluid.screen('stream', '${dtps.classes[t].id}');" class="item main back">\n                        <i class="fluid-icon">keyboard_arrow_left</i>    \n                        <span class="label">Classes</span>\n                    </div>\n\n                    <div class="divider"></div>\n\n                    ${n}\n                `),e&&dtps.loadPage(t,e),$(".sidebar .item:not(.back)").click((function(s){$(this).siblings().removeClass("active"),$(this).addClass("active");var e=$(this).attr("data-pageID");dtps.loadPage(t,e)}))}})).catch((s=>{dtps.error("Couldn't fetch pages","Caught promise rejection @ dtps.loadPagesList",s)})))},dtps.loadPage=function(s,e,n){dtps.selectedClass!=s||"pages"!=dtps.selectedContent&&!n||jQuery(".classContent").html('\n             <div style="margin: 20px; padding: 20px;">\n                <h4><span class="shimmer">[SHIMMER] Class page title</span></h4>\n\n                <div style="margin-bottom: 32px;" class="discussionHeader">\n                    <h5 class="shimmer">Page author name</h5>\n\n                    <i class="fluid-icon shimmer">calendar_today</i>\n                    <span class="shimmer">[SHIMMER] Last updated at</span>\n                </div>\n\n                \x3c!-- Page content --\x3e\n                <br />\n                <div class="shimmer" style="margin: 10px 0px; width: 100%; height: 600px; border: none; outline: none;"></div>\n            </div>\n         '),dtpsLMS.fetchPageContent(dtps.classes[s].lmsID,e).then((function(e){if(dtps.selectedClass==s&&("pages"==dtps.selectedContent||n)){var t=getComputedStyle($(".classContent")[0]).getPropertyValue("--background"),a=getComputedStyle($(".card.details")[0]).getPropertyValue("--text"),i=new Blob([`\n                <base target="_blank" /> \n                <link type="text/css" rel="stylesheet" href="https://cdn.jottocraft.com/CanvasCSS.css" media="screen,projection"/>\n                <style>body {background-color: ${t}; color: ${a};</style>\n                ${e.content}\n            `],{type:"text/html"}),l=window.URL.createObjectURL(i);jQuery(".classContent").html(`\n                ${n?`\n                    <button style="margin: 10px 0px 0px 20px;" class="btn" onclick="fluid.screen('moduleStream', '${dtps.classes[s].id}')">\n                        <i class="fluid-icon">keyboard_arrow_left</i> Back\n                    </button>\n                `:""}\n                <div style="margin: 20px; padding: 20px;">\n                    \x3c!-- Page title --\x3e\n                    <h4 style="font-weight: bold;">${e.title}</h4>\n\n                    \x3c!-- Page header --\x3e\n                    <div style="margin-bottom: 32px;" class="discussionHeader">\n                        ${e.author?`\n                            <img src="${e.author.photoURL}" />\n                            <h5>${e.author.name}</h5>\n                        `:""}\n\n                        <i class="fluid-icon">calendar_today</i>\n                        <span>${"Last Updated "+dtps.formatDate(e.updatedAt)}</span>\n                    </div>\n\n                    \x3c!-- Page content --\x3e\n                    <br />\n                    <iframe id="classPageIframe" onload="dtps.iframeLoad('classPageIframe')" style="margin: 10px 0px; width: 100%; border: none; outline: none;" src="${l}" />\n                </div>\n            `)}})).catch((s=>{dtps.error("Couldn't load page","Caught promise rejection @ dtps.loadPage",s)}))},fluid.externalScreens.discussions=s=>{var e=s.split("|")[0],n=s.split("|")[1],t="true"==s.split("|")[2],a=s.split("|")[3];dtps.loadThreadsList(e,n,t,a)},fluid.externalScreens.pages=s=>{var e=s.split("|")[0],n=s.split("|")[1],t="true"==s.split("|")[2];dtps.loadPagesList(e,n,t)};
//# sourceMappingURL=/scripts/pages-discussions.js.map