/**
 * @file DTPS Canvas LMS Integration
 * @author jottocraft
 * 
 * @copyright Copyright (c) 2018-2020 jottocraft. All rights reserved.
 * @license GPL-2.0-only
 * 
 * JSDoc documentation for these LMS functions can be found near the end of core.js
 */
var dtpsLMS={name:"Canvas LMS",shortName:"Canvas",legalName:"Canvas LMS and Instructure Inc.",description:"Power+ integration for Canvas LMS",url:"https://www.instructure.com/canvas/",logo:"https://i.imgur.com/rGjNVoc.png",source:"https://github.com/jottocraft/dtps/blob/master/scripts/lms/canvas.js",genericGradebook:!0,commonHeaders:{Accept:"application/json+canvas-string-ids, application/json"},fetchUser:function(){return new Promise((function(e,s){jQuery.ajax({url:"/api/v1/users/self",type:"GET",headers:dtpsLMS.commonHeaders,success:function(t){jQuery.ajax({url:"/api/v1/users/self/observees?include[]=avatar_url",type:"GET",headers:dtpsLMS.commonHeaders,success:function(s){var r={name:t.name,id:t.id,photoURL:t.avatar_url};s&&s.length&&(r.children=s.map(e=>({name:e.name,id:e.id,photoURL:e.avatar_url}))),e(r)},error:function(e){s(e)}})},error:function(e){s(e)}})}))},fetchClasses:function(){return new Promise((function(e,s){jQuery.ajax({url:"/api/v1/users/self/colors",type:"GET",headers:dtpsLMS.commonHeaders,success:function(t){jQuery.ajax({url:"/api/v1/users/self/dashboard_positions",type:"GET",headers:dtpsLMS.commonHeaders,success:function(r){jQuery.ajax({url:"/api/v1/users/"+dtps.user.lmsID+"/courses?per_page=100&enrollment_state=active&include[]=term&include[]=total_scores&include[]=public_description&include[]=total_students&include[]=account&include[]=teachers&include[]=course_image&include[]=syllabus_body&include[]=tabs",type:"GET",headers:dtpsLMS.commonHeaders,success:function(s){var o=[];s.forEach((e,s)=>{var r={name:e.course_code,id:e.id,subject:"true"==window.localStorage["pref-fullNames"]?e.course_code:e.course_code.split(" - ")[0],syllabus:e.syllabus_body,homepage:"wiki"==e.default_view,description:e.public_description,numStudents:e.total_students,term:e.course_code.split(" - ")[1],color:t.custom_colors["course_"+e.id],grade:e.enrollments[0].computed_current_score,letter:e.enrollments[0].computed_current_grade,image:e.image_download_url,newDiscussionThreadURL:"/courses/"+e.id+"/discussion_topics/new",pages:e.tabs.map(e=>e.id).includes("pages"),modules:e.tabs.map(e=>e.id).includes("modules"),discussions:e.tabs.map(e=>e.id).includes("discussions")};e.teachers[0]&&(r.teacher={name:e.teachers[0]&&e.teachers[0].display_name,id:e.teachers[0]&&e.teachers[0].id,photoURL:e.teachers[0]&&e.teachers[0].avatar_image_url}),o.push(r)}),o.sort((function(e,s){var t=r.dashboard_positions["course_"+e.id],o=r.dashboard_positions["course_"+s.id];return t<o?-1:t>o?1:0})),e(o)},error:function(e){s(e)}})},error:function(e){s(e)}})},error:function(e){s(e)}})}))},fetchAssignments:function(e){return new Promise((function(s,t){jQuery.ajax({url:"/api/v1/courses/"+e+"/students/submissions?include[]=rubric_assessment&include[]=submission_comments&per_page=100&student_ids[]="+dtps.user.lmsID,type:"GET",headers:dtpsLMS.commonHeaders,success:function(r){jQuery.ajax({url:"/api/v1/users/"+dtps.user.lmsID+"/courses/"+e+"/assignments?per_page=100&include[]=submission",type:"GET",headers:dtpsLMS.commonHeaders,success:function(e){var t=[];e.forEach((e,s)=>{var o={title:e.name,body:e.description,id:e.id,dueAt:e.due_at,url:e.html_url,locked:e.locked_for_user,publishedAt:e.created_at,value:e.points_possible},i={};e.rubric&&e.rubric.forEach(s=>{o.rubric||(o.rubric=[]),o.rubric.push({title:s.description,description:s.long_description,id:s.id,value:s.points,outcome:s.outcome_id,assignmentTitle:e.name,assignmentID:e.id}),i[s.id]={},s.ratings.forEach(e=>{i[s.id][e.points]=e.description})}),r.forEach(s=>{s.assignment_id==e.id&&(s.rubric_assessment&&o.rubric.forEach(e=>{s.rubric_assessment[e.id]&&(e.score=s.rubric_assessment[e.id].points,e.scoreName=i[e.id][e.score])}),o.turnedIn=null!==s.submission_type,o.late=s.late,o.missing=s.missing,o.gradedAt=s.graded_at,o.grade=s.score,isNaN(s.grade)&&(o.letter=s.grade),s.submission_comments&&(o.feedback=[],s.submission_comments.forEach(e=>{var s={comment:e.comment};e.author&&(s.author={name:e.author.display_name,id:e.author.id,photoURL:e.author.avatar_image_url}),o.feedback.push(s)})))}),t.push(o)}),s(t)},error:function(e){t(e)}})},error:function(e){t(e)}})}))},fetchModules:function(e){return new Promise((function(s,t){jQuery.ajax({url:"/api/v1/courses/"+e+"/modules?include[]=items&include[]=content_details",type:"GET",headers:dtpsLMS.commonHeaders,success:function(r){jQuery.ajax({url:"/courses/"+e+"/modules/progressions",type:"GET",headers:dtpsLMS.commonHeaders,success:function(e){var t={};e.forEach(e=>{t[e.context_module_progression.context_module_id]=e.context_module_progression.collapsed});var o=r.map(e=>{var s=[];return e.items.forEach(e=>{"ASSIGNMENT"==e.type.toUpperCase()?s.push({type:"assignment",title:e.title,id:e.content_id,indent:e.indent,completed:e.completion_requirement&&e.completion_requirement.completed}):"PAGE"==e.type.toUpperCase()?s.push({type:"page",title:e.title,id:e.page_url,indent:e.indent,url:e.html_url,completed:e.completion_requirement&&e.completion_requirement.completed}):"DISCUSSION"==e.type.toUpperCase()?s.push({type:"discussion",title:e.title,id:e.content_id,indent:e.indent,url:e.html_url,completed:e.completion_requirement&&e.completion_requirement.completed}):"EXTERNALURL"==e.type.toUpperCase()?s.push({type:"url",title:e.title,url:e.external_url,indent:e.indent,completed:e.completion_requirement&&e.completion_requirement.completed}):"EXTERNALTOOL"==e.type.toUpperCase()?s.push({type:"embed",title:e.title,url:e.html_url,indent:e.indent,completed:e.completion_requirement&&e.completion_requirement.completed}):"SUBHEADER"==e.type.toUpperCase()&&s.push({type:"header",title:e.title,indent:e.indent,completed:e.completion_requirement&&e.completion_requirement.completed})}),{id:e.id,title:e.name,collapsed:t[e.id]||!1,items:s}});s(o)},error:function(e){t(e)}})},error:function(e){t(e)}})}))},collapseModule:function(e,s,t){return new Promise((function(r,o){jQuery.ajax({url:"/courses/"+e+"/modules/"+s+"/collapse",type:"POST",headers:{Accept:"application/json, text/javascript, application/json+canvas-string-ids, */*; q=0.01","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-CSRF-Token":decodeURIComponent(document.cookie).split("_csrf_token=")[1].split(";")[0]},body:"_method=POST&collapse="+(t?1:0)+"&authenticity_token="+decodeURIComponent(document.cookie).split("_csrf_token=")[1].split(";")[0],success:function(e){r()},error:function(e){o(e)}})}))},fetchAnnouncements:function(e){return new Promise((function(s,t){jQuery.ajax({url:"/api/v1/announcements?context_codes[]=course_"+e,type:"GET",headers:dtpsLMS.commonHeaders,success:function(e){var t=e.map((function(e){return{title:e.title,postedAt:e.created_at,body:e.message}}));s(t)},error:function(e){t(e)}})}))},fetchHomepage:function(e){return new Promise((function(s,t){jQuery.ajax({url:"/api/v1/courses/"+e+"/front_page",type:"GET",headers:dtpsLMS.commonHeaders,success:function(e){s(e.body)},error:function(e){t(e)}})}))},fetchDiscussionThreads:function(e){return new Promise((function(s,t){jQuery.ajax({url:"/api/v1/courses/"+e+"/discussion_topics",type:"GET",headers:dtpsLMS.commonHeaders,success:function(e){var t=e.map((function(e){return{title:e.title,id:e.id,locked:e.locked_for_user}}));s(t)},error:function(e){t(e)}})}))},fetchDiscussionPosts:function(e,s){return new Promise((function(t,r){jQuery.ajax({url:"/api/v1/courses/"+e+"/discussion_topics/"+s+"/",type:"GET",headers:dtpsLMS.commonHeaders,success:function(o){function i(e,r){var i=[],n={id:s,body:o.message,postedAt:o.created_at,replyURL:r};if(o.author&&o.author.display_name&&(n.author={name:o.author.display_name,id:o.author.id,photoURL:o.author.avatar_image_url}),i.push(n),e.view){var c={};e.participants&&e.participants.forEach(e=>{c[e.id]=e}),e.view.forEach((function(e){if(!e.deleted){var s=[];if(e.replies){!function e(t,o){t.forEach(t=>{if(!t.deleted){var i={id:t.id,body:t.message,postedAt:t.created_at,replyURL:r+"/entry-"+t.id,depth:o};c[t.user_id]&&(i.author={name:c[t.user_id].display_name,id:t.user_id,photoURL:c[t.user_id].avatar_image_url}),s.push(i)}t.replies&&e(t.replies,o+1)})}(e.replies,0)}var t={id:e.id,body:e.message,postedAt:e.created_at,replies:s,replyURL:r+"/entry-"+e.id};c[e.user_id]&&(t.author={name:c[e.user_id].display_name,id:e.user_id,photoURL:c[e.user_id].avatar_image_url}),i.push(t)}}))}t({title:o.title,id:o.id,locked:o.locked_for_user,posts:i})}o.group_topic_children&&o.group_topic_children.length?jQuery.ajax({url:"/api/v1/courses/"+e+"/groups?only_own_groups=true",type:"GET",headers:dtpsLMS.commonHeaders,success:function(t){var n=t.map(e=>e.id),c=null,a=null;o.group_topic_children.forEach(e=>{n.includes(e.group_id)&&(c=e.group_id,a=e.id)}),c&&a?jQuery.ajax({url:"/api/v1/groups/"+c+"/discussion_topics/"+a+"/view",type:"GET",headers:dtpsLMS.commonHeaders,success:function(e){i(e,"/groups/"+c+"/discussion_topics/"+a)},error:function(e){r(e)}}):jQuery.ajax({url:"/api/v1/courses/"+e+"/discussion_topics/"+s+"/view",type:"GET",headers:dtpsLMS.commonHeaders,success:function(t){i(t,"/courses/"+e+"/discussion_topics/"+s)},error:function(e){r(e)}})},error:function(e){r(e)}}):jQuery.ajax({url:"/api/v1/courses/"+e+"/discussion_topics/"+s+"/view",type:"GET",headers:dtpsLMS.commonHeaders,success:function(t){i(t,"/courses/"+e+"/discussion_topics/"+s)},error:function(e){r(e)}})},error:function(e){r(e)}})}))},fetchPages:function(e){return new Promise((function(s,t){jQuery.ajax({url:"/api/v1/courses/"+e+"/pages?per_page=100",type:"GET",headers:dtpsLMS.commonHeaders,success:function(e){var t=e.map((function(e){return{title:e.title,id:e.url}}));s(t)},error:function(e){t(e)}})}))},fetchPageContent:function(e,s){return new Promise((function(t,r){jQuery.ajax({url:"/api/v1/courses/"+e+"/pages/"+s,type:"GET",headers:dtpsLMS.commonHeaders,success:function(e){var s={title:e.title,id:e.url,updatedAt:e.updated_at,content:e.body};e.last_edited_by&&(s.author={name:e.last_edited_by.display_name,id:e.last_edited_by.id,photoURL:e.last_edited_by.avatar_image_url}),t(s)},error:function(e){r(e)}})}))}},baseURL=document.currentScript.src.split("/scripts/lms/canvas.js")[0];jQuery.getScript(baseURL+"/scripts/core.js");
//# sourceMappingURL=/scripts/lms/canvas.js.map