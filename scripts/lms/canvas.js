/**
 * @file DTPS Canvas LMS Integration
 * @author jottocraft
 * 
 * @copyright Copyright (c) 2018-2021 jottocraft. All rights reserved.
 * @license GPL-2.0-only
 * 
 * JSDoc documentation for these LMS functions can be found near the end of core.js
 */
var dtpsLMS={name:"Canvas LMS",shortName:"Canvas",legalName:"Canvas LMS or Instructure Inc.",description:"Power+ integration for Canvas LMS",url:"https://www.instructure.com/canvas/",logo:"https://i.imgur.com/rGjNVoc.png",source:"https://github.com/jottocraft/dtps/blob/main/scripts/lms/canvas.js",genericGradebook:!0,commonHeaders:{Accept:"application/json+canvas-string-ids, application/json"},teacherCache:{},fetchUser:function(){return new Promise((function(e,t){window.ENV&&window.ENV.current_user.id||t({action:"login",redirectURL:"/?dtpsLogin=true"});var s={name:window.ENV.current_user.display_name,id:window.ENV.current_user.id,photoURL:ENV.current_user.avatar_image_url};window.ENV.current_user_roles.includes("observer")?fetch("/api/v1/users/self/observees?include[]=avatar_url",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((t=>{t&&t.length&&(s.children=t.map((e=>({name:e.name.split(" ")[0],id:e.id,photoURL:e.avatar_url})))),e(s)})).catch(t):e(s)}))},fetchClasses:function(e){return new Promise((function(t,s){Promise.all([fetch("/api/v1/users/"+dtps.user.id+"/colors",{headers:dtpsLMS.commonHeaders}),fetch("/api/v1/users/"+e+"/dashboard_positions",{headers:dtpsLMS.commonHeaders}),fetch("/api/v1/users/"+e+"/courses?per_page=100&enrollment_state=active&include[]=term&include[]=total_scores&include[]=account&include[]=teachers&include[]=course_image&include[]=tabs&include[]=sections",{headers:dtpsLMS.commonHeaders})]).then((e=>Promise.all(e.map((e=>e.json()))))).then((s=>{var[o,r,i]=s,n=[];i.forEach(((t,s)=>{var r={name:t.course_code,id:t.id,lmsID:t.id,people:!dtps.user.parent,userID:e,period:t.sections&&t.sections[0]&&(t.sections.find((e=>/[0-9](?=\(A)/.test(e.name)))||t.sections[0]).name,subject:"true"==window.localStorage["pref-fullNames"]?t.course_code:t.original_name?t.name:t.course_code.split(" - ")[0],homepage:"wiki"==t.default_view,term:t.course_code.split(" - ")[1],color:o.custom_colors["course_"+t.id],grade:t.enrollments[0].computed_current_score,letter:t.enrollments[0].computed_current_grade,image:t.image_download_url,newDiscussionThreadURL:"/courses/"+t.id+"/discussion_topics/new",pages:t.tabs.map((e=>e.id)).includes("pages"),modules:t.tabs.map((e=>e.id)).includes("modules"),discussions:!0,endDate:t.end_at};dtpsLMS.teacherCache[t.id]=t.teachers,t.teachers[0]&&(r.teacher={name:t.teachers[0]&&t.teachers[0].display_name,id:t.teachers[0]&&t.teachers[0].id,photoURL:t.teachers[0]&&t.teachers[0].avatar_image_url}),n.push(r)})),n.sort((function(e,t){var s=r.dashboard_positions["course_"+e.id],o=r.dashboard_positions["course_"+t.id];return s<o?-1:s>o?1:0})),t(n)})).catch(s)}))},fetchAssignments:function(e,t){return new Promise((function(s,o){Promise.all([fetch("/api/v1/courses/"+t+"/students/submissions?include[]=rubric_assessment&include[]=submission_comments&per_page=100&student_ids[]="+e,{headers:dtpsLMS.commonHeaders}),fetch("/api/v1/users/"+e+"/courses/"+t+"/assignments?per_page=100",{headers:dtpsLMS.commonHeaders})]).then((e=>Promise.all(e.map((e=>e.json()))))).then((e=>{var[t,o]=e,r=[];o.forEach(((e,s)=>{var o={title:e.name,body:e.description,id:e.id,dueAt:e.due_at,url:e.html_url,locked:e.locked_for_user,publishedAt:e.created_at,value:e.points_possible},i={};e.rubric&&e.rubric.forEach((t=>{o.rubric||(o.rubric=[]),o.rubric.push({title:t.description,description:t.long_description,id:t.id,value:t.points,outcome:t.outcome_id,assignmentTitle:e.name,assignmentID:e.id}),i[t.id]={},t.ratings.forEach((e=>{i[t.id][e.points]=e.description}))})),t.forEach((t=>{if(t.assignment_id==e.id){t.rubric_assessment&&o.rubric.forEach((e=>{t.rubric_assessment[e.id]&&(e.score=t.rubric_assessment[e.id].points,e.scoreName=i[e.id][e.score])})),o.turnedIn=null!==t.submission_type,o.late=t.late,o.missing=t.missing,o.gradedAt=t.graded_at,o.grade=t.score;var s=t.grade;"complete"==s&&(s="✔️"),"incomplete"==s&&(s="❌"),isNaN(s)&&(o.letter=s),t.submission_comments&&(o.feedback=[],t.submission_comments.forEach((e=>{var t={comment:e.comment};e.author&&(t.author={name:e.author.display_name,id:e.author.id,photoURL:e.author.avatar_image_url}),o.feedback.push(t)})))}})),r.push(o)})),s(r)})).catch(o)}))},fetchModules:function(e,t){return new Promise((function(e,s){Promise.all([fetch("/api/v1/courses/"+t+"/modules?include[]=items&include[]=content_details",{headers:dtpsLMS.commonHeaders}),fetch("/courses/"+t+"/modules/progressions",{headers:dtpsLMS.commonHeaders})]).then((e=>Promise.all(e.map((e=>e.json()))))).then((t=>{var[s,o]=t,r={};o.forEach((e=>{r[e.context_module_progression.context_module_id]=e.context_module_progression.collapsed}));var i=s.map((e=>{var t=[];return e.items.forEach((e=>{"ASSIGNMENT"==e.type.toUpperCase()?t.push({type:"assignment",title:e.title,id:e.content_id,indent:e.indent,url:e.html_url,completed:e.completion_requirement&&e.completion_requirement.completed}):"PAGE"==e.type.toUpperCase()?t.push({type:"page",title:e.title,id:e.page_url,indent:e.indent,url:e.html_url,completed:e.completion_requirement&&e.completion_requirement.completed}):"DISCUSSION"==e.type.toUpperCase()?t.push({type:"discussion",title:e.title,id:e.content_id,indent:e.indent,url:e.html_url,completed:e.completion_requirement&&e.completion_requirement.completed}):"EXTERNALURL"==e.type.toUpperCase()?t.push({type:"url",title:e.title,url:e.external_url,indent:e.indent,completed:e.completion_requirement&&e.completion_requirement.completed}):"EXTERNALTOOL"==e.type.toUpperCase()?t.push({type:"embed",title:e.title,url:e.html_url,indent:e.indent,completed:e.completion_requirement&&e.completion_requirement.completed}):"SUBHEADER"==e.type.toUpperCase()&&t.push({type:"header",title:e.title,indent:e.indent,completed:e.completion_requirement&&e.completion_requirement.completed})})),{id:e.id,title:e.name,collapsed:r[e.id]||!1,items:t}}));e(i)})).catch(s)}))},collapseModule:function(e,t,s){return fetch("/courses/"+e+"/modules/"+t+"/collapse",{method:"POST",headers:{Accept:"application/json, text/javascript, application/json+canvas-string-ids, */*; q=0.01","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-CSRF-Token":decodeURIComponent(document.cookie).split("_csrf_token=")[1].split(";")[0]},body:"_method=POST&collapse="+(s?1:0)+"&authenticity_token="+decodeURIComponent(document.cookie).split("_csrf_token=")[1].split(";")[0]})},collapseAllModules:function(e,t){return fetch("/courses/"+e+"/collapse_all_modules",{method:"POST",headers:{Accept:"application/json, text/javascript, application/json+canvas-string-ids, */*; q=0.01","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-CSRF-Token":decodeURIComponent(document.cookie).split("_csrf_token=")[1].split(";")[0]},body:"_method=POST&collapse="+(t?1:0)+"&authenticity_token="+decodeURIComponent(document.cookie).split("_csrf_token=")[1].split(";")[0]})},fetchAnnouncements:function(e){return new Promise((function(t,s){fetch("/api/v1/announcements?context_codes[]=course_"+e,{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((e=>{var s=e.map((function(e){return{title:e.title,postedAt:e.created_at,body:e.message,url:e.html_url}}));t(s)})).catch(s)}))},fetchUsers:function(e){return new Promise((function(t,s){fetch("/api/v1/courses/"+e+"/sections?include[]=avatar_url&include[]=students&per_page=99",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((s=>{var o=dtpsLMS.teacherCache[e],r=[{title:"Teachers",id:"lms.dtps.canvas-teachers",users:[]}];o.forEach((t=>{r[0].users.push({name:t.display_name,id:t.id,photoURL:t.avatar_image_url,url:"/courses/"+e+"/users/"+t.id})})),s.forEach((t=>{if(t.students){var s=[];t.students.forEach((t=>{s.push({name:t.short_name,id:t.id,photoURL:t.avatar_url,url:"/courses/"+e+"/users/"+t.id})}));var o=t.name.match(/[0-9](?=\(A)/);dtpsLMS.dtech&&o&&(t.name=7==o[0]?"@d.tech":"Period "+o[0]),r.push({title:t.name,id:t.id,users:s})}})),t(r)})).catch(s)}))},fetchHomepage:function(e){return new Promise((function(t,s){fetch("/api/v1/courses/"+e+"/front_page",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((e=>{t(e.body)})).catch(s)}))},fetchDiscussionThreads:function(e){return new Promise((function(t,s){fetch("/api/v1/courses/"+e+"/discussion_topics",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((e=>{var s=e.map((function(e){return{title:e.title,id:e.id,locked:e.locked_for_user}}));t(s)})).catch(s)}))},fetchDiscussionPosts:function(e,t){return new Promise((function(s,o){fetch("/api/v1/courses/"+e+"/discussion_topics/"+t+"/",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((o=>{function r(e,r){var i=[],n={id:t,body:o.message,postedAt:o.created_at,replyURL:r};if(o.author&&o.author.display_name&&(n.author={name:o.author.display_name,id:o.author.id,photoURL:o.author.avatar_image_url}),i.push(n),e.view){var a={};e.participants&&e.participants.forEach((e=>{a[e.id]=e})),e.view.forEach((function(e){if(!e.deleted){var t=[];if(e.replies){!function e(s,o){s.forEach((s=>{if(!s.deleted){var i={id:s.id,body:s.message,postedAt:s.created_at,replyURL:r+"/entry-"+s.id,depth:o};a[s.user_id]&&(i.author={name:a[s.user_id].display_name,id:s.user_id,photoURL:a[s.user_id].avatar_image_url}),t.push(i)}s.replies&&e(s.replies,o+1)}))}(e.replies,0)}var s={id:e.id,body:e.message,postedAt:e.created_at,replies:t,replyURL:r+"/entry-"+e.id};a[e.user_id]&&(s.author={name:a[e.user_id].display_name,id:e.user_id,photoURL:a[e.user_id].avatar_image_url}),i.push(s)}}))}s({title:o.title,id:o.id,locked:o.locked_for_user,posts:i})}o.group_topic_children&&o.group_topic_children.length?fetch("/api/v1/courses/"+e+"/groups?only_own_groups=true",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((s=>{var i=s.map((e=>e.id)),n=null,a=null;o.group_topic_children.forEach((e=>{i.includes(e.group_id)&&(n=e.group_id,a=e.id)})),n&&a?fetch("/api/v1/groups/"+n+"/discussion_topics/"+a+"/view",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((e=>{r(e,"/groups/"+n+"/discussion_topics/"+a)})):fetch("/api/v1/courses/"+e+"/discussion_topics/"+t+"/view",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((s=>{r(s,"/courses/"+e+"/discussion_topics/"+t)}))})):fetch("/api/v1/courses/"+e+"/discussion_topics/"+t+"/view",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((s=>{r(s,"/courses/"+e+"/discussion_topics/"+t)}))})).catch(o)}))},fetchPages:function(e){return new Promise((function(t,s){fetch("/api/v1/courses/"+e+"/pages?per_page=100",{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((e=>{var s=e.map((function(e){return{title:e.title,id:e.url}}));t(s)})).catch(s)}))},fetchPageContent:function(e,t){return new Promise((function(s,o){fetch("/api/v1/courses/"+e+"/pages/"+t,{headers:dtpsLMS.commonHeaders}).then((e=>e.json())).then((e=>{var t={title:e.title,id:e.url,updatedAt:e.updated_at,content:e.body};e.last_edited_by&&(t.author={name:e.last_edited_by.display_name,id:e.last_edited_by.id,photoURL:e.last_edited_by.avatar_image_url}),s(t)})).catch(o)}))}},baseURL=document.currentScript.src.split("/scripts/lms/canvas.js")[0];jQuery.getScript(baseURL+"/scripts/core.js");
//# sourceMappingURL=/scripts/lms/canvas.js.map