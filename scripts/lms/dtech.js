/**
 * @file d.tech-specific features, CBL & grade calculation
 * @author jottocraft
 * 
 * @copyright Copyright (c) 2018-2021 jottocraft. All rights reserved.
 * @license GPL-2.0-only
 * 
 * JSDoc documentation for these LMS functions can be found near the end of core.js
 */
var baseURL=document.currentScript.src.split("/scripts/lms/dtech.js")[0];jQuery.getScript(baseURL+"/scripts/lms/canvas.js",(function(){dtpsLMS.name="d.tech",dtpsLMS.legalName="Canvas LMS, Design Tech High School, or Instructure Inc",dtpsLMS.description="Power+ integration for Canvas LMS, customized for d.tech",dtpsLMS.logo="https://i.imgur.com/efGrLq3.png",dtpsLMS.source="https://github.com/jottocraft/dtps/blob/main/scripts/lms/dtech.js",dtpsLMS.useRubricGrades=!0,dtpsLMS.institutionSpecific=!0,dtpsLMS.genericGradebook=!1,dtpsLMS.dtech=!0,dtpsLMS.isUsualDueDate=function(e){return(e=new Date(e)).getHours()>=22||(21==e.getHours()&&e.getMinutes()>50||e.getHours()<8)},dtpsLMS.updateAssignments=function(s){return new Promise(((r,a)=>{r(s.map((s=>(s.rubric&&s.rubric.forEach((s=>{s.scoreName=e(s.scoreName),void 0!==s.score&&(s.color=t(s.score))})),s))))}))},dtpsLMS.updateClasses=function(e){return new Promise(((t,s)=>{var r=[];e.forEach(((e,t)=>{(e.term==dtps.remoteConfig.dtechCurrentTerm||e.id==dtps.remoteConfig.debugClassID||!e.endDate||new Date<new Date(e.endDate))&&r.push(e),dtps.remoteConfig.showVideoMeetingButton&&!dtps.user.parent&&e.homepage&&e.term===dtps.remoteConfig.dtechCurrentTerm||(e.videoMeetingURL=null);var s=e.period.match(/[0-9](?=\(A)/);s&&s[0]?e.period="7"==s[0]?0:Number(s[0]):/(d|design)(\.| |-)?lab/gi.test(e.subject)?e.period=11:/exploration/gi.test(e.subject)?e.period=12:e.period=1/0,dtps.user.parent||"false"===window.localStorage.getItem("pref-autoGroupClasses")||(e.period>=1&&e.period<=3?e.group="Cycle 1/3":e.period>=4&&e.period<=6?e.group="Cycle 2/4":11!=e.period&&12!=e.period||(e.group="Intersession")),e.id==dtps.remoteConfig.debugClassID?e.icon="bug_report":/Game/gi.test(e.subject)?e.icon="games":/Architecture/gi.test(e.subject)?e.icon="architecture":/History/gi.test(e.subject)?e.icon="history_edu":/Biology/gi.test(e.subject)?e.icon="biotech":/Physics|Science|Chemistry/gi.test(e.subject)?e.icon="science":/Math|Algebra|Geometry|Calculus|Statistics/gi.test(e.subject)?e.icon="calculate":/Engineering|DRG/gi.test(e.subject)?e.icon="engineering":/((d|design)(\.| |-)?lab)|Prototyping/gi.test(e.subject)?e.icon="design_services":/Exploration/gi.test(e.subject)?e.icon="explore":/@d.?tech/gi.test(e.subject)?e.icon="school":/English/gi.test(e.subject)?e.icon="description":/Model( |-|)(United Nations|UN)/gi.test(e.subject)?e.icon="public":/Spanish|Language/gi.test(e.subject)?e.icon="translate":/Government/gi.test(e.subject)?e.icon="gavel":/(Koi|Live)( |-|)Stream/gi.test(e.subject)?e.icon="live_tv":/Film/gi.test(e.subject)?e.icon="camera_roll":/Leadership/gi.test(e.subject)?e.icon="stars":/Athletics/gi.test(e.subject)&&(e.icon="sports_handball")})),e=r,dtps.user.parent||"false"===window.localStorage.getItem("pref-autoGroupClasses")||e.sort(((e,t)=>e.period-t.period)),t(e)}))},dtpsLMS.fetchMeetingURL=function(e){return new Promise(((t,s)=>{var r=dtps.classes.find((t=>t.id==e));r.homepage&&r.term==dtps.remoteConfig.dtechCurrentTerm&&dtpsLMS.fetchHomepage(e).then((e=>{for(var s=null,r=0;r<$(e).find("a").length;r++){var a=$($(e).find("a")[r]);a.children("img").attr("alt")&&a.children("img").attr("alt").toUpperCase().includes("ZOOM BUTTON")&&a.attr("href")?s=a.attr("href"):a.attr("href")&&a.attr("href").includes("zoom.us")}t(s)}))}))},dtpsLMS.calculateGrade=function(e,t){var r=null;if(("20-21"==e.term||String(e.id).includes(dtps.remoteConfig.debugClassID))&&(r="2020s1"),r){var a=s.run(t,r);return a?{letter:a.results.letter,dtech:a}:void 0}};var e=function(e){return String(e).toUpperCase().includes("PIONEERING")?"Pioneering":String(e).toUpperCase().includes("PROFICIENT")?"Proficient":String(e).toUpperCase().includes("DEVELOPING")?"Developing":String(e).toUpperCase().includes("EMERGING")?"Emerging":!String(e).includes(" ")&&String(e).length<=20?e:""},t=function(e){return e>4?"#20D684":4==e?"#41BA35":e>=3.9?"#50BC39":e>=3.8?"#5FBD3D":e>=3.7?"#6EBF40":e>=3.6?"#7DC044":e>=3.5?"#8CC248":e>=3.4?"#9AC44C":e>=3.3?"#A9C550":e>=3.2?"#B8C753":e>=3.1?"#C7C857":e>=3?"#D6CA5B":e>=2.9?"#D8C35A":e>=2.8?"#DABB59":e>=2.7?"#DCB458":e>=2.6?"#DEAC57":e>=2.5?"#E1A556":e>=2.4?"#E39E55":e>=2.3?"#E59654":e>=2.2?"#E78F53":e>=2.1?"#E98752":e>=2?"#EB8051":e>=1.9?"#E97A50":e>=1.8?"#E7744F":e>=1.7?"#E56F4E":e>=1.6?"#E3694D":e>=1.5?"#E1634C":e>=1.4?"#DE5D4A":e>=1.3?"#DC5749":e>=1.2?"#DA5248":e>=1.1?"#D84C47":e>=1?"#D64646":e>=0?"#D72727":e<0?"#BF0000":void 0},s={letters:["A","A-","B+","B","B-","C","I"],params:{"2020s1":{percentage:{A:3.3,"A-":3.3,"B+":2.6,B:2.6,"B-":2.6,C:2.2,I:0},lowest:{A:3,"A-":2.5,"B+":2.2,B:1.8,"B-":1.5,C:1.5,I:0}}},average:function(e){var t=0;return e.forEach((e=>t+=e)),t/e.length},run:function(e,t,s){var r=[],a=s||{};if("2020s1"==t){if(s||e.forEach((e=>{e.rubric&&e.rubric.forEach((e=>{void 0!==e.score&&e.outcome&&(a[e.outcome]||(a[e.outcome]={scores:[]}),a[e.outcome].scores.push(e),e.title&&(a[e.outcome].title=e.title))}))})),0==Object.keys(a).length)return;Object.values(a).forEach((e=>{var t=e.scores.map((e=>e.score)).filter((e=>null!==e)),s=this.average(t),r=Math.min(...t),a=t.slice();a.splice(a.indexOf(r),1);var o=this.average(a);o>s?(e.scoreType="dropped",e.droppedScore=e.scores.map((e=>e.score)).indexOf(r),e.average=o):(e.scoreType="all",e.average=s,delete e.droppedScore)}));var o=Object.values(a).map((e=>e.average));r.push(this.getLetter(o,t,"all"))}var n=null;return r.forEach((e=>{(!n||this.letters.indexOf(e.letter)<this.letters.indexOf(n.letter))&&(n=e)})),{results:n,formula:t,outcomes:a}},getLetter:function(e,t,s){var r={};if(e.sort(((e,t)=>t-e)),"2020s1"==t){var a=[],o=Math.floor(.75*e.length);1==e.length?r.number75=e[0]:r.number75=e[o-1],r.number75thresh=o;for(var n=null,c=0;c<this.letters.length;c++){let e=this.letters[c];if(r.number75>=this.params[t].percentage[e]){n=e;break}}a.push(n);n=null;r.lowestScore=e[e.length-1];for(c=0;c<this.letters.length;c++){let e=this.letters[c];if(r.lowestScore>=this.params[t].lowest[e]){n=e;break}}a.push(n)}var i=a.map((e=>this.letters.indexOf(e))),l=Math.max(...i);return{letter:this.letters[l],parameters:r,variation:s}}};dtpsLMS.gradebook=function(e){return new Promise(((r,a)=>{if(e.gradeCalculation&&e.gradeCalculation.dtech){if("2020s1"==e.gradeCalculation.dtech.formula)var o=`\n                    <div id="gradeSummary" style="--size: 250px; margin: 0px 20px; --classColor: ${e.color};" class="grid flex">\n                      <div style="background-color: var(--classColor); color: white;" class="block status letterGrade card">\n                        <h2 class="main">${e.letter}</h2>\n                        ${e.previousLetter?`<h5 class="previousGrade">Previous grade: ${e.previousLetter}</h5>`:""}\n                        <h5 class="bottom"><i class="fluid-icon">grade</i> Grade</h5>\n                      </div>\n                      <div class="block status number75">\n                        <h2 class="main numFont">${e.gradeCalculation.dtech.results.parameters.number75.toFixed(2)}</h2>\n                        <h5 class="bottom"><i class="fluid-icon">functions</i> 75% of outcomes (${e.gradeCalculation.dtech.results.parameters.number75thresh}) ≥</h5>\n                      </div>\n                      <div class="block status lowestScore">\n                        <h2 class="main numFont">${e.gradeCalculation.dtech.results.parameters.lowestScore.toFixed(2)}</h2>\n                        <h5 class="bottom"><i class="fluid-icon">leaderboard</i> Lowest outcome</h5>\n                      </div>\n                    </div>\n\n                    <div style="--classColor: ${e.color};${dtps.gradebookExpanded?"":"display: none;"}" id="classGradeMore">\n                            <br />\n                            <table class="table">\n                                <thead>\n                                    <tr>\n                                    <th>&nbsp;&nbsp;Final Letter</th>\n                                    <th>75% (rounded down) of outcome scores is ≥</th>\n                                    <th>No outcome scores below</th>\n                                    </tr>\n                                </thead>\n\n                                <tbody>\n                                    ${s.letters.map((t=>`\n                                            <tr class="letter${t} ${e.letter==t?"active":""}">\n                                                <td>&nbsp;&nbsp;${t}</td>\n                                                <td>${s.params[e.gradeCalculation.dtech.formula].percentage[t]}</td>\n                                                <td>${s.params[e.gradeCalculation.dtech.formula].lowest[t]}</td>\n                                            </tr>\n                                        `)).join("")}\n                                </tbody>\n                            </table>\n                        </div>\n\n                    <div onclick="$('#classGradeMore').toggle(); if ($('#classGradeMore').is(':visible')) {$(this).children('i').text('keyboard_arrow_up'); $(this).children('span').text('Show less'); dtps.gradebookExpanded = true;} else {$(this).children('i').text('keyboard_arrow_down'); $(this).children('span').text('Show more'); dtps.gradebookExpanded = false;}" class="gradeSummaryShowHide">\n                        ${dtps.gradebookExpanded?'<i class="fluid-icon">keyboard_arrow_up</i> <span>Show less</span>':'<i class="fluid-icon">keyboard_arrow_down</i> <span>Show more</span>'}\n                    </div>\n                `;else o="";var n=[],c=!1;Object.keys(e.gradeCalculation.dtech.outcomes).sort((function(t,s){var r=e.gradeCalculation.dtech.outcomes[t].average,a=e.gradeCalculation.dtech.outcomes[s].average;return null==r&&(r=999999-e.gradeCalculation.dtech.outcomes[t].scores.length),null==a&&(a=999999-e.gradeCalculation.dtech.outcomes[s].scores.length),r>a?1:r<a?-1:0})).forEach((s=>{var r=e.gradeCalculation.dtech.outcomes[s],a=!c&&!r.scores.length;a&&(c=!0),n.push(`\n                    ${a?'<h5 style="font-weight: bold;margin: 75px 75px 10px 75px;">Unassesed outcomes</h5>':""}\n\n                    <div style="border-radius: 20px;padding: 22px; padding-bottom: 20px;" class="card outcomeResults outcome-${s}">\n                        <h5 style="max-width: calc(100% - 50px); font-size: 24px; margin: 0px; margin-bottom: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer;">${r.title}</h5>\n\n                        ${void 0!==r.average?`\n                            <div id="outcomeScore${s}" class="numFont" style="position: absolute; top: 20px; right: 20px; font-size: 26px; font-weight: bold; display: inline-block; color: ${t(r.average)}">${r.average.toFixed(2)}</div>\n                        `:""}\n                        \n                        <div class="assessments">\n                            ${0==r.scores.length?'\n                                    <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 6px 0px; color: var(--secText);">This outcome has not been assessed yet</p>\n                            ':r.scores.map(((t,a)=>`\n                                        <div class="assessmentWrapper ${a==r.droppedScore?"dropped":""}" id="outcome${t.outcome}assessment${a}" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 6px 0px;">\n                                            <div style="color: ${t.color};" aIndex="${a}" outcomeID="${s}" class="editableScore" ${dtps.remoteConfig.allowWhatIfGrades?"contenteditable":""}>${t.score}</div>\n                                            <span class="assessmentTitle" style="cursor: pointer;" onclick="dtps.assignment('${t.assignmentID}', ${e.num});">${t.assignmentTitle}</span>\n                                        </div>\n                                    `)).join("")}\n                        </div>\n\n                        ${dtps.remoteConfig.allowWhatIfGrades?`\n                            <p class="addWhatIf" outcomeID="${s}" style="font-size: 14px; color: var(--secText); margin: 0px; margin-top: 16px; cursor: pointer;">\n                                <i style="cursor: pointer; vertical-align: middle; font-size: 16px;" class="fluid-icon down">add_box</i>\n                                Add a What-If grade\n                            </p>\n                        `:""}\n                    </div>\n                `)})),r(`\n                    <div style="--classColor: ${e.color}" class="card" id="whatIfResults">\n                        <div style="display: inline-block;">\n                           <h5>\n                              What-If Grade\n                              <div class="resultLetter">--</div>\n                           </h5>\n                           <p style="color: var(--lightText);" class="resultPercentage"></p>\n                           <p>This grade is hypothetical and does not represent your actual grade for this class.</p>\n                           <p onclick="fluid.screen();" style="color: var(--secText); cursor: pointer;">Show actual grades</p>\n                        </div>\n                    </div>\n                `+o+"<br />"+n.join(""))}else r()}))};var r=!1;dtpsLMS.gradebookDidRender=function(e){if($(".card.outcomeResults .assessments .editableScore").toArray().forEach((t=>{a(t,e)})),$("p.addWhatIf").click((function(){c(e,$(this).attr("outcomeID"))})),!r){r=!0;var t=document.getElementById("gradeSummary").offsetTop-parseFloat($("body").css("padding-top"))-10;window.onscroll=function(){window.pageYOffset>=t&&dtps.classes[dtps.selectedClass]&&"grades"==dtps.selectedContent?$(".classContent").addClass("fixedGradeSummary"):$(".classContent").removeClass("fixedGradeSummary")}}};var a=function(e,s){e.addEventListener("input",(function(){o(s);var r=Number($(e).text());$(e).text()&&$(e).text().length<4&&!isNaN(r)&&r>=0&&r<=4?($(e).css("color",t(r)),s.gradeCalculation.dtech.whatIfOutcomes[Number($(e).attr("outcomeID"))].scores[Number($(e).attr("aIndex"))].whatIfGrade||r!==s.gradeCalculation.dtech.outcomes[Number($(e).attr("outcomeID"))].scores[Number($(e).attr("aIndex"))].score?$(e).addClass("modified"):$(e).removeClass("modified"),s.gradeCalculation.dtech.whatIfOutcomes[Number($(e).attr("outcomeID"))].scores[Number($(e).attr("aIndex"))].score=r,n(s)):($(e).css("color","var(--secText)"),$(e).addClass("modified"),s.gradeCalculation.dtech.whatIfOutcomes[Number($(e).attr("outcomeID"))].scores[Number($(e).attr("aIndex"))].score=null,n(s))}),!1),e.addEventListener("focus",(function(){$(e).addClass("focused")}),!1),e.addEventListener("blur",(function(){$(e).hasClass("whatIf")&&""==$(e).text()?($(e).parent().remove(),s.gradeCalculation.dtech.whatIfOutcomes[Number($(e).attr("outcomeID"))].scores[Number($(e).attr("aIndex"))].score=null):$(e).removeClass("focused")}),!1),e.addEventListener("keydown",(function(t){function s(e){if(e.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var s=window.getSelection();s.removeAllRanges(),s.addRange(t)}else if(void 0!==document.body.createTextRange){var r=document.body.createTextRange();r.moveToElementText(e),r.collapse(!1),r.select()}}if("ArrowDown"==t.key)t.preventDefault(),(r=$(".editableScore").toArray())[r.indexOf(e)+1]&&s(r[r.indexOf(e)+1]);else if("ArrowUp"==t.key){var r;t.preventDefault(),(r=$(".editableScore").toArray())[r.indexOf(e)-1]&&s(r[r.indexOf(e)-1])}}),!1)},o=function(e){$("#gradeSummary").hasClass("whatIf")||(e.gradeCalculation.dtech.whatIfOutcomes=JSON.parse(JSON.stringify(e.gradeCalculation.dtech.outcomes)),$("#gradeSummary .block.card").css("background-color",""),$("#gradeSummary .block.card").css("color","var(--classColor)"),$("#gradeSummary .block.card h5.bottom").html('<i class="fluid-icon">analytics</i> What-If Grade'),$("#gradeSummary .block.card .previousGrade").remove(),$("#gradeSummary .block.card h2.main").after('<h5 onclick="fluid.screen();" class="showActualGrades">Show actual grades</h5>'),$("#gradeSummary").addClass("whatIf"),$("#classGradeMore").addClass("whatIf"))},n=function(e){if(e.gradeCalculation.dtech.whatIfOutcomes){var r=s.run(e.assignments,e.gradeCalculation.dtech.formula,e.gradeCalculation.dtech.whatIfOutcomes);e.gradeCalculation.dtech.whatIfOutcomes=r.outcomes,$("#gradeSummary .block.letterGrade h2.main").html(r.results.letter),$("#gradeSummary .block.number75 h2.main").html(r.results.parameters.number75.toFixed(2)),$("#gradeSummary .block.lowestScore h2.main").html(r.results.parameters.lowestScore.toFixed(2)),$("#classGradeMore .table tr").removeClass("active"),$("#classGradeMore .table tr.letter"+r.results.letter).addClass("active"),$(".card.outcomeResults .dropped").removeClass("dropped"),Object.keys(e.gradeCalculation.dtech.whatIfOutcomes).forEach((s=>{var r=e.gradeCalculation.dtech.whatIfOutcomes[s];void 0!==r.average&&($("#outcomeScore"+s).html(r.average.toFixed(2)),$("#outcomeScore"+s).css("color",t(r.average))),void 0!==r.droppedScore&&$("#outcome"+s+"assessment"+r.droppedScore).addClass("dropped")}))}},c=function(e,t){o(e);var s=e.gradeCalculation.dtech.whatIfOutcomes[t].scores.length;e.gradeCalculation.dtech.whatIfOutcomes[t].scores.push({id:"whatIf"+s,score:null,value:4,whatIfGrade:!0,outcome:t,color:"var(--secText)",assignmentTitle:"What-If Grade",description:"A What-If grade",title:e.gradeCalculation.dtech.whatIfOutcomes[t].title,assignmentID:null}),$(".card.outcomeResults.outcome-"+t+" .assessments").append(`\n            <div class="assessmentWrapper" id="outcome${t}assessment${s}" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 6px 0px;">\n                <div style="color: var(--secText);" aIndex="${s}" outcomeID="${t}" class="editableScore modified whatIf" contenteditable></div>\n                <span class="assessmentTitle">What-If Grade</span>\n            </div>\n        `),a($(`#outcome${t}assessment${s} .editableScore`)[0],e)}}));
//# sourceMappingURL=/scripts/lms/dtech.js.map