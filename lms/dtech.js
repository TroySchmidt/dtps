/**
 * @file d.tech-specific features, CBL & grade calculation
 * @author jottocraft
 * 
 * @copyright Copyright (c) 2018-2020 jottocraft. All rights reserved.
 * @license GPL-2.0-only
 * 
 * JSDoc documentation for these LMS functions can be found near the end of core.js
 */
var baseURL=document.currentScript.src.split("/")[0]+"//"+document.currentScript.src.split("/")[2];jQuery.getScript(baseURL+"/scripts/lms/canvas.js",(function(){dtpsLMS.name="d.tech";dtpsLMS.legalName="Canvas LMS, Design Tech High School, and Instructure Inc";dtpsLMS.description="Power+ integration for Canvas LMS, customized for d.tech";dtpsLMS.logo="https://i.imgur.com/efGrLq3.png";dtpsLMS.source="https://github.com/jottocraft/dtps/blob/master/scripts/lms/dtech.js";dtpsLMS.useRubricGrades=true;dtpsLMS.institutionSpecific=true;dtpsLMS.genericGradebook=false;dtpsLMS.updateAssignments=function(rawAssignments){return rawAssignments.map(assignment=>{if(assignment.rubric){assignment.rubric.forEach(rubricItem=>{rubricItem.scoreName=shortenDtechRubricScoreName(rubricItem.scoreName);if(rubricItem.score){rubricItem.color=dtechRubricColor(rubricItem.score/rubricItem.value)}})}return assignment})};dtpsLMS.calculateGrade=function(course,assignments){var formula="sem2";var dtechResults=dtechGradeCalc.run(assignments,formula);if(dtechResults){return{letter:dtechResults.results.letter,grade:98,dtech:dtechResults}}else{return}};var shortenDtechRubricScoreName=function(rating){if(String(rating).toUpperCase().includes("PIONEERING"))return"Pioneering";if(String(rating).toUpperCase().includes("PROFICIENT"))return"Proficient";if(String(rating).toUpperCase().includes("DEVELOPING"))return"Developing";if(String(rating).toUpperCase().includes("EMERGING"))return"Emerging";if(!String(rating).includes(" ")&&String(rating).length<=20)return rating;return""};var dtechRubricColor=function(percentage){if(percentage>=1)return"#4f9e59";if(percentage>=.75)return"#a1b553";if(percentage>=.5)return"#c26d44";if(percentage>=.25)return"#c4474e";if(percentage>=0)return"#bd3139"};var dtechGradeCalc={letters:["A","A-","B+","B","B-","C","I"],params:{sem2:{percentage:{A:3.3,"A-":3.3,"B+":2.6,B:2.6,"B-":2.6,C:2.2,I:0},lowest:{A:3,"A-":2.5,"B+":2.2,B:1.8,"B-":1.5,C:1.5,I:0}}},average:function(array){var sum=0;array.forEach(item=>sum+=item);return sum/array.length},run:function(assignments,formula="sem2"){var gradeVariations=[];var outcomes={};if(formula=="sem2"){assignments.forEach(assignment=>{if(assignment.rubric){assignment.rubric.forEach(rubricItem=>{if(rubricItem.score&&rubricItem.outcome){if(!outcomes[rubricItem.outcome]){outcomes[rubricItem.outcome]={scores:[]}}outcomes[rubricItem.outcome].scores.push(rubricItem);if(rubricItem.title)outcomes[rubricItem.outcome].title=rubricItem.title}})}});if(Object.keys(outcomes).length==0)return;Object.values(outcomes).forEach(outcome=>{var outcomeScores=outcome.scores.map(RubricItem=>RubricItem.score);var average=this.average(outcomeScores);var lowestScore=Math.min(...outcomeScores);var droppedArray=outcomeScores.slice();droppedArray.splice(droppedArray.indexOf(lowestScore),1);var droppedAverage=this.average(droppedArray);if(droppedAverage>average){outcome.scoreType="dropped";outcome.droppedScore=outcomeScores.indexOf(lowestScore);outcome.average=droppedAverage}else{outcome.scoreType="all";outcome.average=average}});var outcomeAvgs=Object.values(outcomes).map(outcome=>outcome.average);gradeVariations.push(this.getLetter(outcomeAvgs,formula,"all"))}var bestVariation=null;gradeVariations.forEach(variation=>{if(!bestVariation||this.letters.indexOf(variation.letter)<this.letters.indexOf(bestVariation.letter)){bestVariation=variation}});return{results:bestVariation,formula:formula,outcomes:outcomes}},getLetter:function(outcomeAvgs,formula,variation){var parameters={};outcomeAvgs.sort((a,b)=>b-a);if(formula=="sem2"){var letters=[];var percentage=.75;var numOutcomesRequired=Math.floor(outcomeAvgs.length*percentage);if(outcomeAvgs.length==1){parameters.number75=outcomeAvgs[0]}else{parameters.number75=outcomeAvgs[numOutcomesRequired-1]}parameters.number75thresh=numOutcomesRequired;var bestLetter=null;for(var i=0;i<this.letters.length;i++){let letter=this.letters[i];if(parameters.number75>=this.params[formula].percentage[letter]){bestLetter=letter;break}}letters.push(bestLetter);parameters.lowestScore=outcomeAvgs[outcomeAvgs.length-1];for(var i=0;i<this.letters.length;i++){let letter=this.letters[i];if(parameters.lowestScore>=this.params[formula].lowest[letter]){bestLetter=letter;break}}letters.push(bestLetter)}var letterIndexes=letters.map(letter=>this.letters.indexOf(letter));var lowestLetterIndex=Math.max(...letterIndexes);var letter=this.letters[lowestLetterIndex];return{letter:letter,parameters:parameters,variation:variation}}};dtpsLMS.gradebook=function(course){return new Promise((resolve,reject)=>{if(course.gradeCalculation&&course.gradeCalculation.dtech){if(course.gradeCalculation.dtech.formula=="sem2"){var gradeCalcSummary=`\n                    <div style="--classColor: ${course.color}" class="card">\n\n                        <h3 class="gradeTitle">\n                            Grades\n\n                            <div class="classGradeCircle">\n                                <div class="letter">${course.letter}</div>\n                            </div>\n\n                        </h3>\n\n                        <h5 class="gradeStat">\n                            75% (rounded down) of outcome scores are ≥\n                            <div class="numFont">${course.gradeCalculation.dtech.results.parameters.number75.toFixed(1)}</div>\n                        </h5>\n\n                        <h5 class="gradeStat">\n                            No outcome scores are lower than\n                            <div class="numFont">${course.gradeCalculation.dtech.results.parameters.lowestScore.toFixed(1)}</div>\n                        </h5>\n\n                        <div style="${dtps.gradebookExpanded?"":"display: none;"}" id="classGradeMore">\n                            <br />\n\n                            ${course.previousLetter?`\n                            <h5 class="smallStat">\n                                Previous Grade\n                                <div class="numFont">${course.previousLetter}</div>\n                            </h5>\n                            `:``}\n\n                            ${course.gradeCalculation.dtech.results.parameters.number75thresh?`\n                            <h5 class="smallStat">\n                                75% of outcomes (rounded down) is\n                                <div class="numFont">${course.gradeCalculation.dtech.results.parameters.number75thresh}</div>\n                            </h5>\n                            `:``}\n                        \n                            <br />\n\n                            <table class="u-full-width dtpsTable">\n                                <thead>\n                                    <tr>\n                                    <th>&nbsp;&nbsp;Final Letter</th>\n                                    <th>75% (rounded down) of outcome scores is ≥</th>\n                                    <th>No outcome scores below</th>\n                                    </tr>\n                                </thead>\n\n                                <tbody>\n                                    ${dtechGradeCalc.letters.map(letter=>`\n                                            <tr ${course.letter==letter?`style="background-color: var(--classColor); font-size:20px; font-weight: bold;"`:``}>\n                                                <td>&nbsp;&nbsp;${letter}</td>\n                                                <td>${dtechGradeCalc.params[course.gradeCalculation.dtech.formula].percentage[letter]}</td>\n                                                <td>${dtechGradeCalc.params[course.gradeCalculation.dtech.formula].lowest[letter]}</td>\n                                            </tr>\n                                        `).join("")}\n                                </tbody>\n                            </table>\n                        </div>\n\n                        <br />\n\n                        <br />\n                        <a onclick="$('#classGradeMore').toggle(); if ($('#classGradeMore').is(':visible')) {$(this).html('Show less'); dtps.gradebookExpanded = true;} else {$(this).html('Show more'); dtps.gradebookExpanded = false;}"\n                            style="color: var(--secText, gray); cursor: pointer; margin-right: 10px;">${dtps.gradebookExpanded?"Show less":"Show more"}</a>\n                        <a style="color: var(--secText, gray);">Using Jan-Mar 2020 Grade Calculation</a>\n                    </div>\n                `}else{var gradeCalcSummary=""}var outcomeHTML=[];var dividerAdded=false;Object.keys(course.gradeCalculation.dtech.outcomes).sort((function(a,b){var keyA=course.gradeCalculation.dtech.outcomes[a].average,keyB=course.gradeCalculation.dtech.outcomes[b].average;if(keyA==undefined){keyA=999999-course.gradeCalculation.dtech.outcomes[a].scores.length}if(keyB==undefined){keyB=999999-course.gradeCalculation.dtech.outcomes[b].scores.length}if(keyA>keyB)return 1;if(keyA<keyB)return-1;return 0})).forEach(outcomeID=>{var outcome=course.gradeCalculation.dtech.outcomes[outcomeID];var divider=!dividerAdded&&!outcome.scores.length;if(divider)dividerAdded=true;outcomeHTML.push(`\n                    ${divider?`<h5 style="font-weight: bold;margin: 75px 75px 10px 75px;">Unassesed outcomes</h5>`:""}\n\n                    <div style="border-radius: 20px;padding: 22px; padding-bottom: 20px;" class="card outcomeResults outcome-${outcomeID}">\n                        <h5 style="max-width: calc(100% - 50px); font-size: 24px; margin: 0px; margin-bottom: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer;">${outcome.title}</h5>\n\n                        ${outcome.average!==undefined?`\n                            <div id="outcomeScore${outcomeID}" style="position: absolute; top: 20px; right: 20px; font-size: 26px; font-weight: bold; display: inline-block; color: ${dtechRubricColor(outcome.average/4)}">${outcome.average.toFixed(2)}</div>\n                        `:``}\n                        \n                        <div class="assessments">\n                            ${outcome.scores.length==0?`\n                                    <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 6px 0px; color: var(--secText);">This outcome has not been assessed yet</p>\n                            `:outcome.scores.map((assessment,aIndex)=>`<p id="outcome${assessment.outcome}assessment${assessment.id}" class="${aIndex==outcome.droppedScore?"dropped":""}" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 6px 0px;">\n                                            <span aIndex="${aIndex}" style="outline: none;margin-right: 5px; font-size: 20px; vertical-align: middle; color: ${assessment.color}">${assessment.score}</span>\n                                            <span class="assessmentTitle" style="cursor: pointer;" onclick="dtps.assignment('${assessment.assignmentID}', ${course.num});">${assessment.assignmentTitle}</span>\n                                        </p>`).join("")}\n                        </div>\n                    </div>\n                `)});resolve(gradeCalcSummary+`<br />`+outcomeHTML.join(""))}else{resolve()}})}}));
//# sourceMappingURL=/scripts/lms/dtech.js.map